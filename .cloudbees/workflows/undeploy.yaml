apiVersion: automation.cloudbees.io/v1alpha1
kind: workflow
name: Undeploy
on:
  push:
    branches:
      - "**"
jobs:
  gcloud:
    steps:
      - uses: docker://kiwigrid/gcloud-kubectl-helm:latest
        name: Add cred file
        run: |
          rm -rf ${HOME}/.kube
          mkdir ${HOME}/.kube && cat >> ${HOME}/.kube/config.json << EOF
          ${{ secrets.mlcbMultilinePass }}
          EOF
      - uses: docker://kiwigrid/gcloud-kubectl-helm:latest
        name: cat [or od -a]
        run: |
          whoami
          cd ${HOME}/.kube
          cat config.json
          touch ${HOME}/.kube/config
          chmod -R 0777 ${HOME}/.kube
          cd ${HOME}
          ls -la
      - uses: docker://kiwigrid/gcloud-kubectl-helm:latest
        name: GCLOD
        run: |
          export KUBECONFIG=${HOME}/.kube/config
          echo $KUBECONFIG
          gcloud auth login --cred-file=${HOME}/.kube/config.json 
          gcloud config set project mlcbplatformproject
          gcloud container clusters get-credentials mlcb-platform-cluster-ap001 --region us-east1 --project mlcbplatformproject 
          kubectl delete service deployment-mlcb
          kubectl delete deployment deployment-mlcb
